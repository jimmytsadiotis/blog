---
layout: post
title: Centralized Dependency License Compliance with GitHub Rulesets and FOSSA
description: Implementing organization-wide dependency license compliance using GitHub repository rulesets and FOSSA, eliminating the need for per-repo workflows.
summary: This post details how to enforce dependency license compliance across numerous repositories using GitHub repository rulesets and FOSSA, providing a centralized and scalable solution.
tags: github, devops, security, dependencies, licenses, automation, fossa, rulesets
minute: 7
---

# Centralized Dependency License Compliance with GitHub Rulesets and FOSSA

## Description

The objective is to ensure that all third-party dependencies used in our organization's codebase comply with predefined licensing policies. This involves developing a tool that automatically checks the licenses of these dependencies against a whitelist and blacklist. The tool will be integrated into our CI/CD pipeline to provide continuous monitoring and compliance enforcement, mitigating legal risks and ensuring adherence to open source usage policies.

## Problem

We need to avoid creating individual workflows in each repository due to the large number of repositories.

## Goal

* Scan dependencies for unwanted licenses.
* Configure license compliance at the organization level in GitHub.
* Fail the pipeline if license requirements are not met.

## Approach

We will use GitHub repository rulesets to implement FOSSA scans across our repositories.

* Repository rulesets allow us to add a FOSSA scan as a required workflow for pull requests.
* Rulesets use a centralized workflow file, enabling scans across many repositories with a single file.

### Set up the Central FOSSA Scan Workflow

1.  **Create a Repository for Workflows:**
    * Create a new repository (e.g., `required-workflows`) to store common workflows.
    * Choose the repository visibility that matches the widest visibility of the repositories you want to scan.
    * Add the FOSSA workflow file at `.github/workflows/fossa.yml`.

    ```yaml
    name: FOSSA

    on:
      pull_request: {}
      workflow_dispatch: {}
      merge_group:
        types: [checks_requested]

    jobs:
      fossa:
        runs-on: ubuntu-20.04 #or self-hosted
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2

          - name: Install FOSSA
            run: |
              curl -H 'Cache-Control: no-cache' [https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh](https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh) | bash

          - name: Set FOSSA API Key
            env:
              FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
            run: echo "FOSSA_API_KEY=${FOSSA_API_KEY}" >> $GITHUB_ENV

          - name: Run FOSSA Analysis
            run: fossa analyze

          - name: Run FOSSA Test
            run: fossa test
            #remove continue-on-error: true to fail pipeline if needed.
    ```
    For self hosted runners, and to prevent pipeline failure by default, use this:
    ```yaml
    name: FOSSA

    on:
      pull_request: {}
      workflow_dispatch: {}
      merge_group:
        types: [checks_requested]

    jobs:
      fossa:
        runs-on: self-hosted
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2

          - name: Install FOSSA
            run: |
              mkdir -p /home/github-runner/bin
              curl -H 'Cache-Control: no-cache' [https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh](https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh) | bash -s -- -b /home/github-runner/bin
              ls -l /home/github-runner/bin
              chmod +x /home/github-runner/bin/fossa

          - name: Add FOSSA to PATH
            run: echo "/home/github-runner/bin" >> $GITHUB_PATH

          - name: Set FOSSA API Key
            env:
              FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
            run: echo "FOSSA_API_KEY=${FOSSA_API_KEY}" >> $GITHUB_ENV

          - name: Run FOSSA Analysis
            run: fossa analyze

          - name: Run FOSSA Test
            run: fossa test
            continue-on-error: true
    ```

2.  **Configure Repository Workflow Access:**
    * In the `required-workflows` repository, go to `Settings > Actions > General`.
    * In the "Access" section, select an option to make the workflows accessible to your organization.
    <image>

3.  **Configure an Organization Secret:**
    * Obtain a FOSSA API token.
    * In GitHub, go to `Settings > Secrets and variables > Actions`.
    * Click "New organization secret."
    * Name: `FOSSA_API_KEY`.
    * Value: `[YOUR_FOSSA_API_TOKEN]`.
    * Ensure proper repository access for the organization secret.
    <image>

4.  **Create an Organization Ruleset:**
    * Go to your organization's GitHub settings and click "Repository" then "Repository rulesets".
    * Click "New branch ruleset."
    * Configure enforcement status, bypass list, target repositories, and target branches.
    * Under "Branch protections," check "Require workflows to pass before merging."
    * Click "Add workflow."
    * Select the `required-workflows` repository and the FOSSA workflow file.
    * Click "Add workflow" and "Create."
    <image>

5.  **FOSSA Policies Configuration:**
    * Navigate to your FOSSA dashboard.
    * Configure Issue Settings to reflect your desired policy.
    <image>
    * Create a license policy that reflects your organization's criteria.
    * Assign the policy as the "Default licensing policy."
    * Click "Propagate settings."
    <image>

6.  **Verify by Creating a Pull Request:**
    * Create a pull request in a repository targeted by the ruleset.
    * Review the checks to ensure the FOSSA workflow ran.
    <image>
    * Click "Details" to see FOSSA results.
    <image>
    * To fail the pull request on blocking findings, remove `continue-on-error: true` from `fossa.yml`.